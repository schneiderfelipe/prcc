#!/usr/bin/python3

import logging
import argparse

import prcc

_logging_level = {0: logging.WARNING, 1: logging.INFO, 2: logging.DEBUG}

def cli():
    # TODO: improve helps and descriptions
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "-v", "--verbosity", action="count", default=0, help="increase output verbosity"
    )

    subparsers = parser.add_subparsers(dest="command", help="commands")
    subparsers.required = True

    parser_list = subparsers.add_parser("list", help="list available data")
    parser_import = subparsers.add_parser("import", help="parse and store data")
    parser_export = subparsers.add_parser("export", help="retrieve stored data")
    parser_index = subparsers.add_parser("index", help="show an index")
    parser_import.add_argument(
        "objects", metavar="object", nargs="+", help="objects to import"
    )
    parser_export.add_argument(
        "objects", metavar="object", nargs="+", help="objects to export"
    )
    parser_import.add_argument(
        "--from",
        "-f",
        dest="source",
        default="av-daily-adjusted",
        choices=["infofundos", "av-daily-adjusted"],
        help="source of data",
    )
    parser_index.add_argument(
        "name", choices=prcc._b3_indices, type=str.lower, help="index name"
    )
    parser_export.add_argument("--to", "-t", dest="dest", help="destination of data")
    args = parser.parse_args()

    logging.basicConfig(level=_logging_level[args.verbosity])

    if args.command == "list":
        for item in prcc.collection.list_items():
            print(item)
    elif args.command == "import":
        prcc.import_objects(args.objects, args.source)
    elif args.command == "export":
        dataframe = prcc.export_objects(args.objects)
        if args.dest is not None:
            # TODO: test extension to support other file types
            dataframe.to_csv(args.dest)
        else:
            print(dataframe.to_csv())
    elif args.command == "index":
        tickers = prcc.get_index(args.name)
        print("\n".join(tickers))


if __name__ == "__main__":
    cli()
